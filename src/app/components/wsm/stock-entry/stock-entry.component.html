<style>
  input[type="tel"] {
    min-width: 7ch;
  }
</style>
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Stock Entry for {{formatDisplayDate(selectedDate)}}</h3>
    <div class="d-flex gap-2">
      <!-- Copy to CouchDB button -->
      @if (!isDataLoaded) {
        <button pButton type="button" label="COPY to COUCH" (click)="copyDataToCouch()" class="p-button-info" [disabled]="isCopying">
          @if (isCopying) {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
          }
        </button>
      }
      @if (!isDataLoaded && !isLoading) {
        <button pButton type="button" label="Load Data" (click)="loadData()" class="p-button-primary"></button>
      }
      @if (isDataLoaded) {
        <button pButton type="button" (click)="save()" class="p-button-success" [disabled]="isSaving">
          @if (!isSaving) { Save }
          @if (isSaving) {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Saving...
          }
        </button>
      }
    </div>
  </div>

  <!-- Loading/Copy progress spinner -->
  @if (isLoading || isCopying) {
    <div class="text-center mt-4">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">{{ isLoading ? 'Loading' : 'Copying' }}...</span>
      </div>
      @if (copyProgress) {
        <p class="mt-2">{{ copyProgress }}</p>
      }
    </div>
  }

  <!-- Initial state message -->
  @if (!isDataLoaded && !isLoading && !isCopying) {
    <div class="alert alert-info">
      Click "Load Data" to enter stock details.
    </div>
  }

  <!-- Data table -->
  @if (isDataLoaded && !isLoading && !isCopying) {
  <form [formGroup]="form" class="mt-3">
    <p-table [value]="rows.controls" [scrollable]="true" scrollHeight="calc(100vh - 250px)" styleClass="p-datatable-sm p-datatable-gridlines" formArrayName="rows">
      <ng-template pTemplate="header">
        <tr>
          <th pFrozenColumn style="width: 70px;">Index</th>
          <th pFrozenColumn style="width: 250px;">Name</th>
          <th style="width: 150px;" class="text-end">Q</th>
          <th style="width: 150px;" class="text-end">P</th>
          <th style="width: 150px;" class="text-end">N</th>
          <th style="width: 150px;" class="text-end">D</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body">
        @for (row of rows.controls; track row.get('seq')?.value) {
          <tr [formGroupName]="$index">
            <td pFrozenColumn>{{ $index + 1 }}</td>
            <td pFrozenColumn>{{ row.get('name')?.value }}</td>
            <td class="text-end">
              <input #qqtyInput type="tel" class="form-control form-control-sm text-end" formControlName="qqty" (change)="onNumberInput($index, 'qqty', qqtyInput.value)">
            </td>
            <td class="text-end">
              <input #pqtyInput type="tel" class="form-control form-control-sm text-end" formControlName="pqty" (change)="onNumberInput($index, 'pqty', pqtyInput.value)">
            </td>
            <td class="text-end">
              <input #nqtyInput type="tel" class="form-control form-control-sm text-end" formControlName="nqty" (change)="onNumberInput($index, 'nqty', nqtyInput.value)">
            </td>
            <td class="text-end">
              <input #dqtyInput type="tel" class="form-control form-control-sm text-end" formControlName="dqty" (change)="onNumberInput($index, 'dqty', dqtyInput.value)">
            </td>
          </tr>
        }
      </ng-template>
    </p-table>
  </form>
}